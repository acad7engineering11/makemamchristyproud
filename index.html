<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Quiz Player</title>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg-page: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --success: #10b981;
            --success-bg: #ecfdf5;
            --error: #ef4444;
            --error-bg: #fef2f2;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: var(--font-main);
            background-color: var(--bg-page);
            color: var(--text-main);
            min-height: 100vh;
            display: flex; justify-content: center;
        }

        /* --- LAYOUT CONTAINER --- */
        #app {
            width: 100%; max-width: 600px;
            min-height: 100vh;
            background: var(--bg-card);
            position: relative;
            display: flex; flex-direction: column;
            overflow-x: hidden;
        }

        @media (min-width: 600px) {
            #app {
                min-height: auto; margin: 40px 20px;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                min-height: 600px;
            }
            body { align-items: flex-start; }
        }

        /* --- VIEW MANAGEMENT --- */
        .view {
            display: none; flex-direction: column;
            padding: 24px; flex: 1;
            animation: fadeIn 0.3s ease-out;
        }
        .view.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TYPOGRAPHY & BUTTONS --- */
        h1 { font-size: 1.5rem; color: var(--primary); margin: 0 0 10px 0; }
        h2 { font-size: 1.25rem; margin: 0 0 15px 0; }
        p { color: var(--text-muted); line-height: 1.6; margin-bottom: 20px; }

        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            width: 100%; padding: 14px; border: none; border-radius: var(--radius);
            font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 8px;
            transition: 0.2s; min-height: 48px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary { background: white; border: 2px solid var(--border); color: var(--text-main); }
        .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-text { background: none; color: var(--text-muted); width: auto; padding: 8px; }
        
        /* --- ERROR STATE --- */
        .error-box {
            text-align: center; color: var(--error);
            padding: 20px; background: var(--error-bg);
            border-radius: var(--radius); border: 1px solid var(--error);
        }

        /* --- START SCREEN --- */
        .mode-card {
            border: 2px solid var(--border); border-radius: var(--radius);
            padding: 16px; margin-bottom: 12px; cursor: pointer; display: block; position: relative;
        }
        .mode-card input { position: absolute; opacity: 0; }
        .mode-card:has(input:checked) { border-color: var(--primary); background-color: #eef2ff; }
        .mode-title { font-weight: 700; display: block; margin-bottom: 4px; }
        .mode-desc { font-size: 0.85rem; color: var(--text-muted); display: block; }

        /* --- QUIZ UI --- */
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .badge { background: #f1f5f9; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }

        .progress-track { background: var(--border); height: 6px; border-radius: 3px; margin-bottom: 24px; overflow: hidden; }
        .progress-fill { background: var(--primary); height: 100%; width: 0%; transition: width 0.3s ease; }

        .question-text { font-size: 1.2rem; margin-bottom: 24px; font-weight: 600; }
        .options-grid { display: grid; gap: 12px; }
        
        .option-btn {
            background: white; border: 2px solid var(--border); padding: 16px;
            border-radius: var(--radius); text-align: left; font-size: 1rem;
            cursor: pointer; position: relative;
        }
        .option-btn.selected { border-color: var(--primary); background: #eef2ff; color: var(--primary); font-weight: 600; }
        .option-btn.correct { border-color: var(--success); background: var(--success-bg); color: #065f46; }
        .option-btn.wrong { border-color: var(--error); background: var(--error-bg); color: #991b1b; }
        .option-btn.disabled { pointer-events: none; }

        .explanation { margin-top: 20px; padding: 16px; background: #f8fafc; border-left: 4px solid var(--primary); border-radius: 4px; }
        .hidden { display: none !important; }

        .quiz-footer { margin-top: auto; padding-top: 20px; display: flex; gap: 12px; }

        /* --- RESULTS --- */
        .score-container { text-align: center; margin: 20px 0; padding: 30px; background: var(--primary); color: white; border-radius: var(--radius); }
        .score-big { font-size: 3rem; font-weight: 800; }
        .review-item { border-bottom: 1px solid var(--border); padding: 15px 0; font-size: 0.9rem; }
        .review-status.correct { color: var(--success); font-weight: bold; }
        .review-status.wrong { color: var(--error); font-weight: bold; }
    </style>
</head>
<body>

<div id="app">
    <!-- 1. LOADING VIEW -->
    <section id="view-loading" class="view active" style="justify-content:center; align-items:center; text-align:center;">
        <div style="border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
        <p style="margin-top:15px">Loading Quiz Data...</p>
    </section>

    <!-- 2. ERROR VIEW -->
    <section id="view-error" class="view" style="justify-content:center;">
        <div class="error-box">
            <h2>‚ö†Ô∏è Unable to Load</h2>
            <p id="error-message">Could not load data.json.</p>
            <p style="font-size:0.85rem">Note: This requires a local server (localhost) due to browser security policies.</p>
            <button id="btn-retry" class="btn btn-secondary" style="margin-top:10px">Retry</button>
        </div>
    </section>

    <!-- 3. START VIEW -->
    <section id="view-start" class="view">
        <h1 id="start-title">Quiz Title</h1>
        <p id="start-desc">Description loading...</p>
        
        <div style="margin-top: 20px;">
            <h3>Select Mode</h3>
            <label class="mode-card">
                <input type="radio" name="mode" value="A" checked>
                <span class="mode-title">‚ö° Instant Feedback</span>
                <span class="mode-desc">See answer immediately after clicking.</span>
            </label>
            <label class="mode-card">
                <input type="radio" name="mode" value="B">
                <span class="mode-title">üìù Exam Mode</span>
                <span class="mode-desc">Answer all questions, check results at the end.</span>
            </label>
        </div>

        <div style="margin-top: auto;">
            <button id="btn-start" class="btn btn-primary">Start Quiz</button>
            <button id="btn-resume" class="btn btn-secondary hidden">Resume Session</button>
        </div>
    </section>

    <!-- 4. QUIZ VIEW -->
    <section id="view-quiz" class="view">
        <header class="quiz-header">
            <span id="quiz-cat-badge" class="badge">General</span>
            <button id="btn-menu" class="btn-text">‚úï Menu</button>
        </header>

        <div class="progress-track">
            <div id="progress-bar" class="progress-fill"></div>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:0.85rem; color:var(--text-muted); margin-bottom:15px;">
            <span id="progress-text">Question 1 of 5</span>
        </div>

        <h2 id="question-text" class="question-text">...</h2>

        <div id="options-container" class="options-grid"></div>

        <div id="explanation-box" class="explanation hidden">
            <strong>Explanation:</strong>
            <span id="explanation-text"></span>
        </div>

        <footer class="quiz-footer">
            <button id="btn-prev" class="btn btn-secondary" disabled>Previous</button>
            <button id="btn-next" class="btn btn-primary">Next</button>
        </footer>
    </section>

    <!-- 5. RESULTS VIEW -->
    <section id="view-results" class="view">
        <h2>Quiz Complete!</h2>
        <div class="score-container">
            <div id="result-percent" class="score-big">0%</div>
            <span id="result-fraction">0/0 Correct</span>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button id="btn-review" class="btn btn-secondary">Review</button>
            <button id="btn-restart" class="btn btn-primary">Restart</button>
        </div>
        <button id="btn-home" class="btn btn-text" style="width:100%; text-align:center;">Back to Menu</button>

        <div id="review-container" class="review-list hidden" style="margin-top:20px;"></div>
    </section>
</div>

<script>
/**
 * APPLICATION LOGIC
 */
const App = (() => {
    // --- State Management ---
    const state = {
        meta: {},
        questions: [],
        currentIndex: 0,
        answers: {}, 
        mode: 'A',
        isComplete: false
    };

    // --- DOM Cache ---
    const el = (id) => document.getElementById(id);
    const DOM = {
        views: document.querySelectorAll('.view'),
        // Error
        errMsg: el('error-message'),
        btnRetry: el('btn-retry'),
        // Start
        startTitle: el('start-title'),
        startDesc: el('start-desc'),
        btnStart: el('btn-start'),
        btnResume: el('btn-resume'),
        modeInputs: document.querySelectorAll('input[name="mode"]'),
        // Quiz
        badge: el('quiz-cat-badge'),
        btnMenu: el('btn-menu'),
        bar: el('progress-bar'),
        progText: el('progress-text'),
        qText: el('question-text'),
        opts: el('options-container'),
        expBox: el('explanation-box'),
        expText: el('explanation-text'),
        btnPrev: el('btn-prev'),
        btnNext: el('btn-next'),
        // Results
        resPercent: el('result-percent'),
        resFraction: el('result-fraction'),
        btnReview: el('btn-review'),
        btnRestart: el('btn-restart'),
        btnHome: el('btn-home'),
        reviewCont: el('review-container')
    };

    // --- Initialization ---
    const init = () => {
        loadData();
        bindEvents();
    };

    // --- Data Loading (Bug 2 Fix) ---
    const loadData = async () => {
        showView('view-loading');
        try {
            const response = await fetch('./data.json');
            
            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`);
            }

            const data = await response.json();

            // Validate Data Structure
            if (!data.questions || !Array.isArray(data.questions) || data.questions.length === 0) {
                throw new Error('Invalid JSON: Missing "questions" array.');
            }

            // Set State
            state.questions = data.questions;
            state.meta = {
                title: data.quizTitle || 'Quiz',
                desc: data.quizDescription || 'General Knowledge'
            };

            // Update Start Screen
            DOM.startTitle.textContent = state.meta.title;
            DOM.startDesc.textContent = state.meta.desc;

            checkStorage();
            showView('view-start');

        } catch (error) {
            console.error(error);
            DOM.errMsg.textContent = `${error.message}. Ensure data.json exists.`;
            showView('view-error');
        }
    };

    // --- Event Binding ---
    const bindEvents = () => {
        DOM.btnRetry.addEventListener('click', loadData);
        DOM.btnStart.addEventListener('click', startNewQuiz);
        DOM.btnMenu.addEventListener('click', exitToMenu);
        DOM.btnHome.addEventListener('click', exitToMenu);
        
        // Navigation Events
        DOM.btnPrev.addEventListener('click', () => nav(-1));
        
        // Next Button handles both navigation and finishing
        DOM.btnNext.addEventListener('click', () => {
            const isLast = state.currentIndex === state.questions.length - 1;
            if (isLast) finishQuiz();
            else nav(1);
        });

        DOM.btnRestart.addEventListener('click', () => {
            if(confirm("Restart quiz?")) startNewQuiz();
        });
        
        DOM.btnReview.addEventListener('click', () => {
            DOM.reviewCont.classList.toggle('hidden');
            DOM.btnReview.textContent = DOM.reviewCont.classList.contains('hidden') ? 'Review' : 'Hide Review';
        });

        DOM.modeInputs.forEach(input => {
            input.addEventListener('change', (e) => state.mode = e.target.value);
        });

        DOM.btnResume.addEventListener('click', () => {
            const saved = JSON.parse(localStorage.getItem('quiz_progress'));
            if(saved) resumeQuiz(saved);
        });
    };

    // --- Navigation Logic (Bug 1 Fix) ---
    const nav = (dir) => {
        const newIndex = state.currentIndex + dir;
        
        // Validation: Ensure index is within bounds
        if (newIndex >= 0 && newIndex < state.questions.length) {
            state.currentIndex = newIndex;
            renderQuestion();
            saveProgress();
        }
    };

    const updateNavButtons = () => {
        // Prev Button: Disabled on first question
        DOM.btnPrev.disabled = (state.currentIndex === 0);

        // Next Button: Changes to "Finish" on last question
        const isLast = (state.currentIndex === state.questions.length - 1);
        DOM.btnNext.textContent = isLast ? 'Finish Quiz' : 'Next';
        
        // Optional: Highlight finish button
        if(isLast) {
            DOM.btnNext.classList.add('btn-primary');
        }
    };

    // --- Core Quiz Logic ---
    const startNewQuiz = () => {
        state.currentIndex = 0;
        state.answers = {};
        state.isComplete = false;
        state.mode = document.querySelector('input[name="mode"]:checked').value;
        localStorage.removeItem('quiz_progress');
        renderQuestion();
        showView('view-quiz');
    };

    const resumeQuiz = (saved) => {
        state.currentIndex = saved.currentIndex;
        state.answers = saved.answers;
        state.mode = saved.mode;
        renderQuestion();
        showView('view-quiz');
    };

    const renderQuestion = () => {
        const q = state.questions[state.currentIndex];
        const userAns = state.answers[state.currentIndex];
        const hasAnswered = userAns !== undefined;

        // Update Text
        DOM.badge.textContent = q.cat || 'General';
        DOM.qText.textContent = q.q;
        DOM.progText.textContent = `Question ${state.currentIndex + 1} of ${state.questions.length}`;
        
        // Update Bar
        const percent = ((state.currentIndex + 1) / state.questions.length) * 100;
        DOM.bar.style.width = `${percent}%`;

        DOM.expBox.classList.add('hidden');
        DOM.opts.innerHTML = '';

        q.a.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerHTML = `<b>${['A','B','C','D'][idx]}</b>. ${opt}`;
            
            btn.onclick = () => handleAnswer(idx);

            // Visual States
            if (hasAnswered) {
                if (state.mode === 'A') {
                    btn.classList.add('disabled');
                    if (idx === q.c) btn.classList.add('correct');
                    else if (idx === userAns) btn.classList.add('wrong');
                } else {
                    // Mode B
                    if (idx === userAns) btn.classList.add('selected');
                }
            }
            DOM.opts.appendChild(btn);
        });

        if (state.mode === 'A' && hasAnswered) {
            DOM.expText.textContent = q.e;
            DOM.expBox.classList.remove('hidden');
        }

        updateNavButtons();
    };

    const handleAnswer = (idx) => {
        if (state.mode === 'A' && state.answers[state.currentIndex] !== undefined) return;
        state.answers[state.currentIndex] = idx;
        saveProgress();
        renderQuestion();
    };

    const saveProgress = () => {
        localStorage.setItem('quiz_progress', JSON.stringify({
            currentIndex: state.currentIndex,
            answers: state.answers,
            mode: state.mode,
            total: state.questions.length
        }));
    };

    const checkStorage = () => {
        const saved = localStorage.getItem('quiz_progress');
        if (saved) {
            const p = JSON.parse(saved);
            if (p.total === state.questions.length) DOM.btnResume.classList.remove('hidden');
        }
    };

    const finishQuiz = () => {
        const answered = Object.keys(state.answers).length;
        if (answered < state.questions.length && !confirm(`Unanswered questions remain. Submit anyway?`)) return;

        state.isComplete = true;
        localStorage.removeItem('quiz_progress');
        calculateResults();
        showView('view-results');
    };

    const calculateResults = () => {
        let score = 0;
        let html = '';

        state.questions.forEach((q, i) => {
            const u = state.answers[i];
            const isCorrect = u === q.c;
            if (isCorrect) score++;

            html += `<div class="review-item">
                <div><strong>Q${i+1}:</strong> <span class="review-status ${isCorrect?'correct':'wrong'}">${isCorrect?'Correct':'Incorrect'}</span></div>
                <div style="margin:5px 0">${q.q}</div>
                <div style="font-size:0.85rem; color:#64748b">You: <b>${u!==undefined?q.a[u]:'Skipped'}</b> | Correct: <b>${q.a[q.c]}</b></div>
                <div style="margin-top:5px; font-style:italic; font-size:0.8rem">${q.e}</div>
            </div>`;
        });

        DOM.resPercent.textContent = `${Math.round((score / state.questions.length) * 100)}%`;
        DOM.resFraction.textContent = `${score}/${state.questions.length} Correct`;
        DOM.reviewCont.innerHTML = html;
        DOM.reviewCont.classList.add('hidden');
        DOM.btnReview.textContent = 'Review Answers';
    };

    const showView = (id) => {
        DOM.views.forEach(v => v.classList.remove('active'));
        el(id).classList.add('active');
        window.scrollTo(0,0);
    };

    const exitToMenu = () => {
        if(!state.isComplete) saveProgress();
        checkStorage();
        showView('view-start');
    };

    // Style Injection for Animations
    const style = document.createElement('style');
    style.innerHTML = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
    document.head.appendChild(style);

    return { init };
})();

document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>
